name: üß† Crypto_Trading_Bot - CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      PYTHONUNBUFFERED: 1
      DATABASE_URL: postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/${{ secrets.POSTGRES_DB }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
      BINANCE_API_SECRET: ${{ secrets.BINANCE_API_SECRET }}
      BINANCE_TESTNET: "True"

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: $POSTGRES_USER
          POSTGRES_PASSWORD: $POSTGRES_PASSWORD
          POSTGRES_DB: $POSTGRES_DB
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U $POSTGRES_USER"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: üîÑ Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ‚ö° Install uv package manager
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache uv/venv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}

      - name: üì¶ Compile dependencies from pyproject.toml
        run: |
          uv pip compile pyproject.toml -o requirements.txt
          uv pip compile --extra dev pyproject.toml -o requirements.dev.txt

      - name: üîß Install dependencies
        run: |
          uv sync --frozen
          uv sync --frozen --extra dev

      - name: üîç Run Linting (ruff)
        run: |
          echo "Running Linting Checks..."
          ruff check src/ tests/

      - name: üß™ Type check with mypy
        run: |
          mypy src/ tests/

      - name: üß™ Run Tests with Pytest
        run: |
          pytest tests/ --maxfail=1 --disable-warnings -q

      - name: üß™ Run Tests with Coverage
        run: pytest --cov=src tests/ --cov-report=xml

      - name: üì° Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          env_vars: PYTHONUNBUFFERED,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,DATABASE_URL,TELEGRAM_BOT_TOKEN,TELEGRAM_CHAT_ID,SMTP_HOST,SMTP_PORT,SMTP_USER,SMTP_PASS,BINANCE_API_KEY,BINANCE_API_SECRET,BINANCE_TESTNET
        env:
          DATABASE_URL: $DATABASE_URL
